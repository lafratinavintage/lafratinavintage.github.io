---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";

const prodotti = await getCollection("catalogo");
const baseUrl = import.meta.env.BASE_URL;

const strutturaCategorie = prodotti.reduce((acc, p) => {
    const catFull = p.data.categoria || "Altro";
    const [padre, figlio] = catFull.split('/');
    if (!acc[padre]) acc[padre] = new Set();
    if (figlio) acc[padre].add(figlio);
    return acc;
}, {});

const padri = Object.keys(strutturaCategorie).sort();
---

<Layout titolo="Il Nostro Catalogo">
    <section class="py-12">
        <h1 class="text-6xl font-display mb-4 text-brand-orange italic">Il Catalogo</h1>
        <p class="text-xl max-w-2xl text-brand-yellow font-body">Oggetti selezionati con cura.</p>
    </section>

    <section class="sticky py-8 top-16 z-30 mb-10 bg-brand-green/95 backdrop-blur-sm">
        <div class="flex flex-col md:flex-row gap-4 items-stretch">
            <div class="grow">
                <input type="text" id="searchBar" placeholder="Cerca un pezzo unico..." class="w-full h-full p-4 border-4 border-brand-brown shadow-retro focus:outline-none bg-white font-body" />
            </div>

            <div class="relative min-w-[240px]" id="categoryMenu">
                <button id="categoryToggle" class="w-full h-full p-4 border-4 border-brand-brown bg-brand-yellow font-bold uppercase text-sm flex justify-between items-center shadow-retro">
                    <span id="currentCategoryText">Tutte le Categorie</span>
                    <span class="ml-2">▼</span>
                </button>
                
                <div id="mainDropdown" class="absolute top-[calc(100%+4px)] left-0 w-full bg-white border-4 border-brand-brown hidden z-50 shadow-retro max-h-[400px] overflow-y-auto no-scrollbar">
                    <button class="w-full text-left p-3 hover:bg-brand-orange hover:text-white border-b-2 border-brand-brown uppercase text-xs font-bold filter-btn" data-category="all">
                        Mostra Tutto
                    </button>
                    
                    {padri.map(padre => (
                        <div class="relative sub-group-container">
                            <button class="w-full text-left p-3 border-b-2 border-brand-brown flex justify-between items-center hover:bg-brand-orange hover:text-white uppercase text-xs font-bold parent-toggle" data-category={padre}>
                                {padre} 
                                {strutturaCategorie[padre].size > 0 && <span class="text-[10px] transform transition-transform">▶</span>}
                            </button>
                            
                            {strutturaCategorie[padre].size > 0 && (
                                <div class="hidden bg-brand-cream/50 border-b-2 border-brand-brown sub-dropdown">
                                    {[...strutturaCategorie[padre]].sort().map(figlio => (
                                        <button class="w-full text-left p-3 pl-8 hover:bg-brand-yellow uppercase text-[10px] font-bold filter-btn" data-category={`${padre}/${figlio}`}>
                                            {figlio}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>

            <div class="flex items-center gap-2 px-4 border-4 border-brand-brown bg-white shadow-retro h-[60px]">
                <input type="checkbox" id="availableOnly" checked class="w-5 h-5 accent-brand-orange" />
                <label for="availableOnly" class="font-bold uppercase text-[10px] whitespace-nowrap cursor-pointer">Solo disponibili</label>
            </div>
        </div>
    </section>

    <div id="productGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10 mb-20">
        {prodotti.map((p) => (
            <div class="product-card" data-nome={p.data.nome.toLowerCase()} data-categoria={p.data.categoria} data-disponibile={p.data.disponibile.toString()}>
                <a href={`${baseUrl}catalogo/${p.id}`} class="block bg-white border-4 border-brand-brown shadow-retro hover:shadow-retro-hover transition-all overflow-hidden h-full group">
                    <div class="aspect-square border-b-4 border-brand-brown overflow-hidden relative">
                        <img src={p.data.imageUrls[0]} alt={p.data.nome} class="w-full h-full object-cover group-hover:scale-105 transition-transform" />
                        {!p.data.disponibile && (
                            <div class="absolute inset-0 bg-white/40 flex items-center justify-center backdrop-blur-[2px]">
                                <span class="bg-brand-brown text-white px-4 py-2 font-display text-2xl rotate-[-5deg] shadow-lg border-2 border-white">VENDUTO</span>
                            </div>
                        )}
                    </div>
                    <div class="p-6">
                        <h3 class="text-2xl font-display mb-1 leading-tight">{p.data.nome}</h3>
                        <p class="text-[10px] font-bold text-brand-green uppercase tracking-[0.2em] mb-4">{p.data.categoria}</p>
                        <div class="flex justify-between items-center border-t-2 border-brand-brown pt-4 font-body">
                            <span class="text-xs bg-brand-brown text-white px-2 py-1">{p.data.anno}</span>
                            <span class="text-xl font-bold text-brand-orange">{p.data.prezzo} {p.data.valuta}</span>
                        </div>
                    </div>
                </a>
            </div>
        ))}
    </div>
</Layout>

<style>
    /* Nasconde la scrollbar per un look più pulito ma permette lo scorrimento */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .rotate-down { transform: rotate(90deg); }
</style>

<script>
    const categoryToggle = document.getElementById("categoryToggle");
    const mainDropdown = document.getElementById("mainDropdown");
    const categoryMenu = document.getElementById("categoryMenu");
    const parentToggles = document.querySelectorAll(".parent-toggle");
    const filterButtons = document.querySelectorAll(".filter-btn");
    const currentCategoryText = document.getElementById("currentCategoryText");
    const searchBar = document.getElementById("searchBar") as HTMLInputElement;
    const availableOnly = document.getElementById("availableOnly") as HTMLInputElement;
    const cards = document.querySelectorAll(".product-card");

    let activeCategory = "all";

    // 1. Apri/Chiudi menu principale
    categoryToggle?.addEventListener("click", () => {
        mainDropdown?.classList.toggle("hidden");
    });

    // 2. Apri/Chiudi sottocategorie al click
    parentToggles.forEach(toggle => {
        toggle.addEventListener("click", (e) => {
            e.stopPropagation(); // Evita che si chiuda tutto il menu
            const parent = toggle.closest('.sub-group-container');
            const subMenu = parent?.querySelector('.sub-dropdown');
            const arrow = toggle.querySelector('span');
            
            subMenu?.classList.toggle("hidden");
            arrow?.classList.toggle("rotate-down");

            // Se vuoi anche filtrare per la categoria "Padre" al click:
            activeCategory = toggle.getAttribute('data-category') || "all";
            updateFilter();
        });
    });

    // 3. Selezione categoria finale
    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            activeCategory = btn.getAttribute('data-category') || "all";
            if (currentCategoryText) currentCategoryText.textContent = btn.textContent?.trim() || "Tutte le Categorie";
            mainDropdown?.classList.add("hidden"); // Chiudi menu dopo selezione
            updateFilter();
        });
    });

    // 4. Chiudi se clicchi fuori
    document.addEventListener("click", (e) => {
        if (!categoryMenu?.contains(e.target as Node)) {
            mainDropdown?.classList.add("hidden");
        }
    });

    // 5. Funzione Filtro
    function updateFilter() {
        const searchTerm = searchBar.value.toLowerCase();
        const onlyAvailable = availableOnly.checked;

        cards.forEach((card) => {
            const element = card as HTMLElement;
            const nome = element.dataset.nome || "";
            const cat = element.dataset.categoria || "";
            const disp = element.dataset.disponibile === "true";

            const matchesSearch = nome.includes(searchTerm);
            const matchesCat = activeCategory === "all" || cat === activeCategory || cat.startsWith(activeCategory + "/");
            const matchesDisp = !onlyAvailable || disp === true;

            element.style.display = (matchesSearch && matchesCat && matchesDisp) ? "block" : "none";
        });
    }

    searchBar?.addEventListener("input", updateFilter);
    availableOnly?.addEventListener("change", updateFilter);
    updateFilter();
</script>