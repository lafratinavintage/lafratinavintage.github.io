---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";

// 1. Caricamento dati dai file .json
const prodotti = await getCollection("catalogo");
const baseUrl = import.meta.env.BASE_URL;

// 2. Logica Categorie Padre/Figlio
const strutturaCategorie = prodotti.reduce((acc, p) => {
    const catFull = p.data.categoria || "Altro";
    const [padre, figlio] = catFull.split('/');
    if (!acc[padre]) acc[padre] = new Set();
    if (figlio) acc[padre].add(figlio);
    return acc;
}, { });

const padri = Object.keys(strutturaCategorie).sort();
---

<Layout titolo="La Nostra Collezione">
    <section class="py-12">
        <h1 class="text-4xl md:text-6xl font-display text-brand-orange leading-none tracking-tighter capitalize">
            La Nostra Collezione
        </h1>
        <p class="text-lg max-w-2xl text-brand-yellow font-body mt-4 italic">
            Oggetti selezionati con cura, pronti a vivere una nuova storia.
        </p>
    </section>

    <section id="filterSection" class="sticky py-6 top-[100px] z-30 mb-10 bg-brand-green/95 backdrop-blur-sm">
        <div class="flex flex-col md:flex-row gap-4 items-stretch">
            <div class="grow">
                <input 
                    type="text" 
                    id="searchBar" 
                    placeholder="Cerca un mobile, una lampada..." 
                    class="w-full h-full p-4 border-4 border-brand-brown shadow-retro focus:outline-none bg-white font-body" 
                />
            </div>

            <div class="relative min-w-[280px]" id="categoryMenu">
                <button id="categoryToggle" class="w-full h-full p-4 border-4 border-brand-brown bg-brand-yellow font-bold uppercase text-sm flex justify-between items-center shadow-retro">
                    <span id="currentCategoryText">Tutte le Categorie</span>
                    <span class="ml-2">▼</span>
                </button>
                
                <div id="mainDropdown" class="absolute top-[calc(100%+4px)] left-0 w-full bg-white border-4 border-brand-brown hidden z-50 shadow-retro max-h-[400px] overflow-y-auto no-scrollbar">
                    <button class="w-full text-left p-3 hover:bg-brand-orange hover:text-white border-b-2 border-brand-brown uppercase text-xs font-bold filter-btn" data-category="all">
                        Mostra Tutto
                    </button>
                    
                    {padri.map(padre => (
                        <div class="relative sub-group-container">
                            <button class="w-full text-left p-3 border-b-2 border-brand-brown flex justify-between items-center hover:bg-brand-orange hover:text-white uppercase text-xs font-bold filter-btn parent-toggle" data-category={padre}>
                                {padre} 
                                {strutturaCategorie[padre].size > 0 && <span class="text-[10px] transform transition-transform arrow">▶</span>}
                            </button>
                            
                            {strutturaCategorie[padre].size > 0 && (
                                <div class="hidden bg-stone-50 border-b-2 border-brand-brown sub-dropdown">
                                    {[...strutturaCategorie[padre]].sort().map(figlio => (
                                        <button class="w-full text-left p-3 pl-8 hover:bg-brand-yellow uppercase text-[10px] font-bold filter-btn" data-category={`${padre}/${figlio}`}>
                                            {figlio}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        </div>
    </section>

    <div id="productGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10 mb-20">
        {prodotti.map((p) => (
            <div class="product-card" data-nome={p.data.nome.toLowerCase()} data-categoria={p.data.categoria}>
                <a href={`${baseUrl}catalogo/${p.id}`} class="block bg-white border-4 border-brand-brown shadow-retro hover:shadow-retro-hover transition-all overflow-hidden h-full group">
                    <div class="aspect-square border-b-4 border-brand-brown overflow-hidden relative bg-brand-yellow/5">
                        <img 
                            src={p.data.imageUrls[0]} 
                            alt={p.data.nome} 
                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" 
                        />
                    </div>
                    <div class="p-6">
                        <h3 class="text-2xl font-display mb-1 leading-tight">{p.data.nome}</h3>
                        <p class="text-[10px] font-bold text-brand-green uppercase tracking-[0.2em] mb-4">
                            {p.data.categoria.replace('/', ' / ')}
                        </p>
                        <div class="flex justify-between items-center border-t-2 border-brand-brown pt-4 font-body">
                            <span class="text-xs bg-brand-brown text-white px-2 py-1">{p.data.anno}</span>
                            <span class="text-xl font-bold text-brand-orange">{p.data.prezzo} {p.data.valuta}</span>
                        </div>
                    </div>
                </a>
            </div>
        ))}
    </div>
</Layout>

<style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .sub-group-container:hover .sub-dropdown { display: block !important; }
    .sub-group-container:hover .arrow { transform: rotate(90deg); }

    #filterSection { transition: transform 0.4s ease-in-out, opacity 0.3s ease-in-out; }
    .filters-hidden { transform: translateY(-160%); opacity: 0; pointer-events: none; }
</style>

<script>
    const filterSection = document.getElementById("filterSection");
    const categoryToggle = document.getElementById("categoryToggle");
    const mainDropdown = document.getElementById("mainDropdown");
    const categoryMenu = document.getElementById("categoryMenu");
    const filterButtons = document.querySelectorAll(".filter-btn");
    const currentCategoryText = document.getElementById("currentCategoryText");
    const searchBar = document.getElementById("searchBar") as HTMLInputElement;
    const cards = document.querySelectorAll(".product-card");

    let activeCategory = "all";
    let lastScrollY = window.scrollY;

    // 1. LOGICA SCROLL
    window.addEventListener("scroll", () => {
        const currentScrollY = window.scrollY;
        if (filterSection) {
            if (currentScrollY > lastScrollY && currentScrollY > 400) {
                filterSection.classList.add("filters-hidden");
                mainDropdown?.classList.add("hidden");
            } else {
                filterSection.classList.remove("filters-hidden");
            }
        }
        lastScrollY = currentScrollY;
    });

    // 2. APRI/CHIUDI MENU
    categoryToggle?.addEventListener("click", () => {
        mainDropdown?.classList.toggle("hidden");
    });

    // 3. GESTIONE CLICK SU TUTTI I FILTRI (Padri, Figli e Mostra Tutto)
    filterButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            // Evitiamo che il click si propaghi se necessario
            const cat = btn.getAttribute('data-category') || "all";
            activeCategory = cat;

            // Aggiorna il testo visualizzato sul bottone principale
            if (currentCategoryText) {
                if (cat === "all") {
                    currentCategoryText.textContent = "Tutte le Categorie";
                } else {
                    // Prende il testo del bottone cliccato (pulito da freccette)
                    currentCategoryText.textContent = btn.childNodes[0].textContent?.trim() || "Tutte le Categorie";
                }
            }

            // Chiude il menu e aggiorna i prodotti
            mainDropdown?.classList.add("hidden");
            updateFilter();
        });
    });

    // 4. CHIUSURA MENU CLICCANDO FUORI
    document.addEventListener("click", (e) => {
        if (!categoryMenu?.contains(e.target as Node)) {
            mainDropdown?.classList.add("hidden");
        }
    });

    // 5. FUNZIONE FILTRAGGIO
    function updateFilter() {
        const searchTerm = searchBar.value.toLowerCase();
        cards.forEach((card) => {
            const element = card as HTMLElement;
            const nome = element.dataset.nome || "";
            const cat = element.dataset.categoria || "";

            const matchesSearch = nome.includes(searchTerm);
            const matchesCat = activeCategory === "all" || cat === activeCategory || cat.startsWith(activeCategory + "/");

            element.style.display = (matchesSearch && matchesCat) ? "block" : "none";
        });
    }

    searchBar?.addEventListener("input", updateFilter);
    updateFilter();
</script>